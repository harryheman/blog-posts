# React: WebRTC Media Call

–ü—Ä–∏–≤–µ—Ç, –¥—Ä—É–∑—å—è!

–í —ç—Ç–æ–π —Å—Ç–∞—Ç—å–µ —è –ø–æ–∫–∞–∂—É –≤–∞–º, –∫–∞–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –∞—É–¥–∏–æ/–≤–∏–¥–µ–æ –∑–≤–æ–Ω–∫–æ–≤ —Å –ø–æ–º–æ—â—å—é [`WebRTC`](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API).

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∏–º:

- –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä;
- –æ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç —ç—Ç–æ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ë;
- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ –∑–≤–æ–Ω–∫–∞;
- –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë –∏ –º–æ–∂–µ—Ç –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –Ω–µ–≥–æ —Å –≤–∏–¥–µ–æ –∏–ª–∏ –±–µ–∑ –ª–∏–±–æ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–≤–æ–Ω–æ–∫;
- –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏–º–µ—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ;
- –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ `WebRTC` –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞.

[–î–µ–º–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](https://react-webrtc-call.herokuapp.com/).

[–û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è](https://github.com/nguymin4/react-videocall).

–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å [Yarn](https://yarnpkg.com/).

–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è - [Vite](https://vitejs.dev/).

–î–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ - [Sass](https://sass-lang.com/).

–î–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ–¥–∏–∞—Å–µ—Å—Å–∏–∏ (signalling - —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏) –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏ - [–≤–µ–±-—Å–æ–∫–µ—Ç—ã](https://ru.wikipedia.org/wiki/WebSocket) –≤ –ª–∏—Ü–µ [Socket.io](https://socket.io/).

–û—Å–Ω–æ–≤–Ω—ã–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º—ã –±—É–¥–µ–º –æ–ø–∏—Ä–∞—Ç—å—Å—è –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

- [WebRTC 1.0: Real-Time Communication Between Browsers](https://w3c.github.io/webrtc-pc) - –Ω–∞–±–æ—Ä `API` –¥–ª—è –æ–±–º–µ–Ω–∞ –º–µ–¥–∏–∞ –∏ –¥—Ä—É–≥–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –Ω–∞–±–æ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤, –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏;
- [An Offer/Answer Model with the Session Description Protocol (SDP)](https://www.rfc-editor.org/rfc/rfc3264) - –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –±—Ä–∞—É–∑–µ—Ä–∞–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –æ–ø–∏—Å–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ (Session Description Protocol, SDP);
- [Media Capture and Streams](https://w3c.github.io/mediacapture-main) - –Ω–∞–±–æ—Ä `API`, –ø–æ–∑–≤–æ–ª—è—é—â–∏—Ö –±—Ä–∞—É–∑–µ—Ä—É –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫—É —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–°—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã [MDN](https://developer.mozilla.org/) –±—É–¥—É—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å—Å—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.

–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π –ø—Ä–∏–º–µ—Ä–æ–≤, –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö [–∑–¥–µ—Å—å](https://w3c.github.io/webrtc-pc/#simple-peer-to-peer-example) –∏ [–∑–¥–µ—Å—å](https://www.rfc-editor.org/rfc/rfc8829#section-7.1).

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

–°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω–µ–µ –∏ —Å–æ–∑–¥–∞–µ–º —à–∞–±–ª–æ–Ω `React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è`:

```bash
mkdir react-webrtc
cd react-webrtc

yarn create vite client --template react
```

–ü–æ–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —à–∞–±–ª–æ–Ω, –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ –ø—Ä–æ—Ü–µ—Å—Å–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ [P2P-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è](https://ru.wikipedia.org/wiki/%D0%9E%D0%B4%D0%BD%D0%BE%D1%80%D0%B0%D0%BD%D0%B3%D0%BE%D0%B2%D0%B0%D1%8F_%D1%81%D0%B5%D1%82%D1%8C) (peer-to-peer - —Ä–∞–≤–Ω—ã–π –∫ —Ä–∞–≤–Ω–æ–º—É, –æ–¥–Ω–æ—Ä–∞–Ω–≥–æ–≤–∞—è —Å–µ—Ç—å), –æ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö –∏ –º–µ—Ç–æ–¥–∞—Ö, –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞–Ω–Ω—ã—Ö –≤ —ç—Ç–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ.

–í–æ—Ç —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Å–∞–º–æ–º –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ:

- –±—Ä–∞—É–∑–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ê (–¥–∞–ª–µ–µ - `–ê`) –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç (capture) –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–∏–¥–µ–æ–∫–∞–º–µ—Ä–∞ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω). –î–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ [`getUserMedia`](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia):

```javascript
// –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–ª–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–æ—Ç–æ–∫—É
// https://w3c.github.io/mediacapture-main/#constrainable-interface
const config = {
 audio: true,
 video: true
}

// https://w3c.github.io/mediacapture-main/#dom-mediadevices-getusermedia
const localStream = await navigator.mediaDevices.getUserMedia(config)

// –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 1 –∏–ª–∏ –±–æ–ª–µ–µ –º–µ–¥–∏–∞—Ç—Ä–µ–∫–æ–≤
// https://w3c.github.io/mediacapture-main/#dom-mediastream-gettracks
const localTracks = localStream.getTracks()
```

- `–ê` —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä [`RTCPeerConnection`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection) —Å –ø–æ–º–æ—â—å—é [–æ–¥–Ω–æ–∏–º–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/RTCPeerConnection):

```javascript
// https://w3c.github.io/webrtc-pc/#dom-rtcconfiguration
const config = { iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] }

// https://w3c.github.io/webrtc-pc/#interface-definition
const pc = new RTCPeerConnection(config)
```

- `–ê` –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∏ –ø–æ—Ç–æ–∫ –≤ —ç–∫–∑–µ–º–ø–ª—è—Ä `RTCPeerConnection` —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ [`addTrack`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/addTrack):

```javascript
stream.getTracks().forEach((track) => {
 // https://w3c.github.io/webrtc-pc/#dom-rtcpeerconnection-addtrack
 pc.addTrack(track, stream)
})
```

- `–ê` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (offer) –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ [`createOffer`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/createOffer). –î–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç [`RTCLocalSessionDescriptionInit`](https://w3c.github.io/webrtc-pc/#dom-rtclocalsessiondescriptioninit):

```javascript
// https://w3c.github.io/webrtc-pc/#dom-rtcpeerconnection-createoffer
const offer = await pc.createOffer()
```

- `–ê` –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ [`setLocalDescription`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/setLocalDescription), –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–º—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:

```javascript
// https://w3c.github.io/webrtc-pc/#dom-peerconnection-setlocaldescription
pc.setLocalDescription(offer)
```

- –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë (–¥–∞–ª–µ–µ - `–ë`) –ª—é–±—ã–º –¥–æ—Å—Ç—É–ø–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ –≤–µ–±-—Å–æ–∫–µ—Ç—ã (—Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è):

```javascript
socket.emit('call', {
 // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ë
 to: remoteId,
 // –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
 sdp: offer
})
```

- `–ë` —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä `RTCPeerConnection` –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –Ω–µ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ –≤–∏–¥–µ [`RTCSessionDescription`](https://developer.mozilla.org/en-US/docs/Web/API/RTCSessionDescription), —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ [`setRemoteDescription`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/setRemoteDescription). `RTCSessionDescription` (–æ–ø–∏—Å–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏) —Å–æ–∑–¥–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é [–æ–¥–Ω–æ–∏–º–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞](https://developer.mozilla.org/en-US/docs/Web/API/RTCSessionDescription/RTCSessionDescription):

```javascript
// https://w3c.github.io/webrtc-pc/#rtcsessiondescription-class
const sdp = new RTCSessionDescription(desc)
// https://w3c.github.io/webrtc-pc/#dom-peerconnection-setremotedescription
pc.setRemoteDescription(sdp)
```

- –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ `–ê` —Ç—Ä–µ–∫–æ–≤ –∏ –ø–æ—Ç–æ–∫–∞ –≤ —ç–∫–∑–µ–º–ø–ª—è—Ä `RTCPeerConnection` –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ `–ë` –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ [`track`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/track_event), –∫–æ—Ç–æ—Ä–æ–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é [`ontrack`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/ontrack):

```javascript
// —Å–æ–±—ã—Ç–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –≤ –≤–∏–¥–µ –º–∞—Å—Å–∏–≤–∞
// –≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ –≤ –º–∞—Å—Å–∏–≤–µ –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç–∞–∫–æ–π –ø–æ—Ç–æ–∫
// https://w3c.github.io/webrtc-pc/#rtctrackevent
// https://w3c.github.io/webrtc-pc/#dom-rtcpeerconnection-ontrack
pc.ontrack = ({ streams }) => {
 remoteStream = streams[0]
}
```

- `–ë` –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç—Ä–µ–∫–∏ –∏ –ø–æ—Ç–æ–∫ –≤ —ç–∫–∑–µ–º–ø–ª—è—Ä `RTCPeerConnection`, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (answer) —Å –ø–æ–º–æ—â—å—é –º–µ—Ç–æ–¥–∞ [`createAnswer`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/createAnswer), –≤—ã–∑—ã–≤–∞–µ—Ç `setLocalDescription` —Å –æ—Ç–≤–µ—Ç–æ–º –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç `–ê`:

```javascript
// https://w3c.github.io/webrtc-pc/#dom-rtcpeerconnection-createanswer
const answer = await pc.createAnswer()

pc.setLocalDescription(answer)

// —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏—è
socket.emit('call', {
 // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ê
 to: remoteId,
 sdp: answer
})
```

- `–ê`, –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å, —Ç–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `setRemoteDescription` –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç `ontrack`;

- –≤ —ç—Ç–æ –∂–µ –≤—Ä–µ–º—è (–ø–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `setLocalDescription`) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–¥–±–æ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (ICE gathering). –í–æ–∑–Ω–∏–∫–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ [`icecandidate`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/icecandidate_event), –∫–æ—Ç–æ—Ä–æ–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é [`onicecandidate`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/onicecandidate):

```javascript
// https://w3c.github.io/webrtc-pc/#dom-rtcpeerconnection-onicecandidate
// https://w3c.github.io/webrtc-pc/#dom-rtcpeerconnectioniceevent
pc.onicecandidate = ({ candidate }) => {
 // —Å–æ–±—ã—Ç–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç `RTCIceCandidateInit`
 // https://w3c.github.io/webrtc-pc/#dom-rtcicecandidateinit
 // –ø–µ—Ä–µ–¥–∞–µ–º "–∫–∞–Ω–¥–∏–¥–∞—Ç–∞" –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
 socket.emit('call', {
   to: remoteId,
   candidate
 })
}
```

- –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ "–∫–∞–Ω–¥–∏–¥–∞—Ç–∞" –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–æ–π, –æ–Ω–∞ —Å–æ–∑–¥–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä [`RTCIceCandidate`](https://developer.mozilla.org/en-US/docs/Web/API/RTCIceCandidate) —Å –ø–æ–º–æ—â—å—é [–æ–¥–Ω–æ–∏–º–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞](https://developer.mozilla.org/en-US/docs/Web/API/RTCIceCandidate/RTCIceCandidate) –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ [`addIceCandidate`](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection/addIceCandidate):

```javascript
// https://w3c.github.io/webrtc-pc/#rtcicecandidate-interface
const _candidate = new RTCIceCandidate(candidate)

// https://w3c.github.io/webrtc-pc/#dom-peerconnection-addicecandidate
pc.addIceCandidate(_candidate)
```

- –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —Å—Ç–æ—Ä–æ–Ω—ã –º–æ–≥—É—Ç –Ω–∞–ø—Ä—è–º—É—é –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –º–µ–¥–∏–∞–¥–∞–Ω–Ω—ã–º–∏.

–ë–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –∫–∞–∫ –≤—Å–µ —ç—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ –±–æ–ª–µ–µ –Ω–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ, –≤ –¥–æ—Å—Ç—É–ø–Ω–æ–π —Ñ–æ—Ä–º–µ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å [–∑–¥–µ—Å—å](https://webrtcforthecurious.com/).

## –°–µ—Ä–≤–µ—Ä

–ü–æ–∂–∞–ª—É–π, –∏–º–µ–µ—Ç —Å–º—ã—Å–ª –Ω–∞—á–∞—Ç—å —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –º–µ–¥–∏–∞—Å–µ—Å—Å–∏–∏ –º–µ–∂–¥—É –±—Ä–∞—É–∑–µ—Ä–∞–º–∏ (—Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏).

–°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω–µ–µ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º `Node.js-–ø—Ä–æ–µ–∫—Ç` –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
mkdir server
cd server

yarn init -yp

yarn add express socket.io dotenv nanoid

yarn add -D nodemon
```

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

- [`express`](https://expressjs.com/ru/) - `Node.js-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫` –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–≤;
- [`socket.io`](https://www.npmjs.com/package/socket.io) - –±–∏–±–ª–∏–æ—Ç–µ–∫–∞, –æ–±–ª–µ–≥—á–∞—é—â–∞—è —Ä–∞–±–æ—Ç—É —Å –≤–µ–±-—Å–æ–∫–µ—Ç–∞–º–∏;
- [`dotenv`](https://www.npmjs.com/package/dotenv) - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —Å—Ä–µ–¥—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è;
- [`nanoid`](https://www.npmjs.com/package/nanoid) - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤;
- [`nodemon`](https://www.npmjs.com/package/nodemon) - —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.

–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–æ–¥–∞ —Å–µ—Ä–≤–µ—Ä–∞ –∏ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ `package.json`:

```javascript
"type": "module",
"scripts": {
 "dev": "nodemon",
 "start": "node index.js"
}
```

–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª `index.js`:

```bash
touch index.js
```

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ —É—Ç–∏–ª–∏—Ç—ã:

```javascript
import express from 'express'
import { createServer } from 'http'
import { join, dirname } from 'path'
import { fileURLToPath } from 'url'
import { Server } from 'socket.io'
import { config } from 'dotenv'
import initSocket from './utils/initSocket.js'
```

–ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ä–µ–¥—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:

```javascript
config()

const __dirname = dirname(fileURLToPath(import.meta.url))
```

–°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã `express` –∏ —Å–µ—Ä–≤–µ—Ä–∞:

```javascript
const app = express()
const server = createServer(app)
```

–î–æ–±–∞–≤–ª—è–µ–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ —Å–±–æ—Ä–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞:

```javascript
app.use(express.static(join(__dirname, '../client/dist')))
```

–°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä `socket.io` –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:

```javascript
const io = new Server(server, {
 cors: process.env.ALLOWED_ORIGIN,
 serveClient: false
})
io.on('connection', initSocket)
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä:

```javascript
const port = process.env.PORT || 4000
server.listen(port, () => {
 console.log(`Server ready on port ${port} üöÄ`)
})
```

–°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª `.env` –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –Ω–µ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫:

```
ALLOWED_ORIGIN=http://localhost:3000
```

–†–µ–∞–ª–∏–∑—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (`utils/initSocket.js`).

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º `nanoid` –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

```javascript
import { nanoid } from 'nanoid'

const users = {}

// —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–æ–∫–µ—Ç
export default function initSocket(socket) {
 // TODO
}
```

–°–æ–∫–µ—Ç –±—É–¥–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å 5 —Ç–∏–ø–æ–≤ —Å–æ–±—ã—Ç–∏–π:

- `init`: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è `id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ–≥–æ —Å–æ–∫–µ—Ç–∞) –∏ –ø–µ—Ä–µ–¥–∞—á–∞ `id` –∫–ª–∏–µ–Ω—Ç—É;
- `request`: –ø–µ—Ä–µ–¥–∞—á–∞ `id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥—Ä—É–≥–æ–º—É –∫–ª–∏–µ–Ω—Ç—É;
- `call`: –Ω–∞—á–∞–ª–æ –∑–≤–æ–Ω–∫–∞;
- `end`: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞;
- `disconnect`: —Ä–∞–∑—Ä—ã–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–æ–∫–µ—Ç–∞).

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è `id` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–∞—Ç—É:

```javascript
let id

// —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `id` –∞–¥—Ä–µ—Å–∞—Ç–∞, —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –ø–æ–ª–µ–∑–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É - –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
const emit = (userId, event, data) => {
 // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
 const receiver = users[userId]
 if (receiver) {
   // –≤—ã–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
   receiver.emit(event, data)
 }
}
```

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–Ω—ã–µ –≤—ã—à–µ —Å–æ–±—ã—Ç–∏—è:

```javascript
socket
 .on('init', () => {
   id = nanoid(5)
   users[id] = socket
   console.log(id, 'connected')
   socket.emit('init', { id })
 })
 .on('request', (data) => {
   emit(data.to, 'request', { from: id })
 })
 .on('call', (data) => {
   emit(data.to, 'call', { ...data, from: id })
 })
 .on('end', (data) => {
   emit(data.to, 'end')
 })
 .on('disconnect', () => {
   delete users[id]
   console.log(id, 'disconnected')
 })
```

–î—É–º–∞—é, –∑–¥–µ—Å—å –≤—Å–µ –ø–æ–Ω—è—Ç–Ω–æ.

–ë–æ–ª—å—à–µ –æ—Ç –Ω–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∏—á–µ–≥–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

## –ö–ª–∏–µ–Ω—Ç

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –∫–æ–¥–æ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
cd client

yarn add socket.io-client sass react-icons
```

- [`socket.io-client`](https://www.npmjs.com/package/socket.io-client) - –∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å `socket.io`;
- [`sass`](https://www.npmjs.com/package/sass) - `CSS-–ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä`.
- [`react-icons`](https://www.npmjs.com/package/react-icons) - –∏–∫–æ–Ω–∫–∏.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `src` –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–µ–π:

- components
 - MainWindow.jsx - –Ω–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
 - CallModal.jsx - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ
 - CallWindow.jsx - —ç–∫—Ä–∞–Ω –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
 - index.js - –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- styles - —Å—Ç–∏–ª–∏ (—è –Ω–µ –±—É–¥—É –æ –Ω–∏—Ö —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞—Ç—å, –ø—Ä–æ—Å—Ç–æ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏—Ö –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å –∏—Å—Ö–æ–¥–Ω—ã–º –∫–æ–¥–æ–º)
- utils
 - socket.js - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `socket.io`
 - Emitter.js - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å - —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ [`Pub/Sub`](https://ru.wikipedia.org/wiki/%D0%98%D0%B7%D0%B4%D0%B0%D1%82%D0%B5%D0%BB%D1%8C-%D0%BF%D0%BE%D0%B4%D0%BF%D0%B8%D1%81%D1%87%D0%B8%D0%BA_(%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F))
 - MediaDevices.js - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–æ–º
 - PeerConnection.js - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å `RTCPeerConnection`
- App.jsx
- main.jsx

–ù–∞—á–Ω–µ–º —Å —É—Ç–∏–ª–∏—Ç—ã –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤.

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ —É—Ç–∏–ª–∏—Ç–∞

–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–∫–µ—Ç (`utils/socket.js`):

```javascript
import { io } from 'socket.io-client'

// –≤ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ —Å–µ—Ä–≤–µ—Ä –∏ –∫–ª–∏–µ–Ω—Ç –±—É–¥—É—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ (origin),
// –∞ –≤ —Ä–µ–∂–∏–º–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –≤ —Ä–∞–∑–Ω—ã—Ö
const SERVER_URI = import.meta.env.DEV ? 'http://localhost:4000' : ''

const socket = io(SERVER_URI)

export default socket
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `pub/sub` (`utils/Emitter.js`):

```javascript
class Emitter {
 constructor() {
   this.events = {}
 }

 emit(e, ...args) {
   if (this.events[e]) {
     this.events[e].forEach((fn) => fn(...args))
   }
   return this
 }

 on(e, fn) {
   this.events[e] ? this.events[e].push(fn) : (this.events[e] = [fn])
   return this
 }

 off(e, fn) {
   if (e && typeof fn === 'function') {
     const listeners = this.events[e]
     listeners.splice(
       listeners.findIndex((_fn) => _fn === fn),
       1
     )
   } else {
     this.events[e] = []
   }
   return this
 }
}

export default Emitter
```

–î–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç 3 –º–µ—Ç–æ–¥–∞:

- `emit`: –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è;
- `on`: –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ - –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è;
- `off`: –¥–ª—è –æ—Ç–ø–∏—Å–∫–∏ - —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–ª–∏ –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è.

_–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ_: –∫–∞–∂–¥—ã–π –º–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `this`. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ —Ü–µ–ø–æ—á–∫–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, `emitter.on(event1, callback1).on(event2, callback2)`.

–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã `MediaDevices` –∏ `PeerConnection` –±—É–¥—É—Ç —Ä–∞—Å—à–∏—Ä—è—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Emitter`, —Ç–µ–º —Å–∞–º—ã–º –Ω–∞—Å–ª–µ–¥—É—è —É–∫–∞–∑–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã.

–†–∞—Å—Å–º–æ—Ç—Ä–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–æ–º (`utils/MediaDevices.js`):

```javascript
import Emitter from './Emitter'

class MediaDevice extends Emitter {
 start() {
   navigator.mediaDevices
     .getUserMedia({
       audio: true,
       video: true
     })
     .then((stream) => {
       this.stream = stream
       this.emit('stream', stream)
     })
     .catch(console.error)

   return this
 }

 toggle(type, on) {
   if (this.stream) {
     this.stream[`get${type}Tracks`]().forEach((t) => {
       t.enabled = on ? on : !t.enabled
     })
   }

   return this
 }

 stop() {
   if (this.stream) {
     this.stream.getTracks().forEach((t) => { t.stop() })
   }
   // —É–¥–∞–ª—è–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
   this.off()

   return this
 }
}

export default MediaDevice
```

–î–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Emitter` –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç 3 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –º–µ—Ç–æ–¥–∞:

- `start`: –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ–≥–æ –∑–∞–ø–∏—Å–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ –≤—ã–∑–æ–≤–∞ —Å–æ–±—ã—Ç–∏—è `stream`;
- `toggle`: –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ —Ç—Ä–µ–∫–æ–≤. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ç–æ–¥ `getAudioTracks`, –∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ—Ç—Ä–µ–∫–æ–≤ - `getVideoTracks`;
- `stop`: –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞.

–ù–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ `PeerConnection` –æ—Å—Ç–∞–Ω–æ–≤–∏–º—Å—è –ø–æ–¥—Ä–æ–±–Ω–µ–µ.

–î–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Emitter`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `MediaDevices` –∏ —É—Ç–∏–ª–∏—Ç—É `socket`:

```javascript
import Emitter from './Emitter'
import MediaDevice from './MediaDevice'
import socket from './socket'

// –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
const CONFIG = { iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] }

class PeerConnection extends Emitter {
 // TODO
}
```

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `PeerConnection` –≤ –µ–≥–æ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è `id` –∞–¥—Ä–µ—Å–∞—Ç–∞ - —Ç–æ–≥–æ, –∫–æ–º—É –º—ã –∑–≤–æ–Ω–∏–º. –í –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ `id` –∞–¥—Ä–µ—Å–∞—Ç–∞ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, —Å–æ–∑–¥–∞–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä `RTCPeerConnection`, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π `icecandidate` –∏ `track`, —Å–æ–∑–¥–∞–µ—Ç—Å—è —ç–∫–∑–µ–º–ø–ª—è—Ä `MediaDevices` –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∫–∞ (—Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è) –º–µ—Ç–æ–¥–∞ `getDescription`:

```javascript
constructor(remoteId) {
 super()
 this.remoteId = remoteId

 this.pc = new RTCPeerConnection(CONFIG)
 this.pc.onicecandidate = ({ candidate }) => {
   socket.emit('call', {
     to: this.remoteId,
     candidate
   })
 }
 this.pc.ontrack = ({ streams }) => {
   // —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥
   this.emit('remoteStream', streams[0])
 }

 this.mediaDevice = new MediaDevice()
 this.getDescription = this.getDescription.bind(this)
}
```

–ú–µ—Ç–æ–¥ –¥–ª—è —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:

```javascript
// –º–µ—Ç–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–æ–≥–æ, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –∑–≤–æ–Ω–∫–∞
// –∏ –æ–±—ä–µ–∫—Ç —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è `getUserMedia`
start(isCaller, config) {
 this.mediaDevice
   // –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ `stream`
   .on('stream', (stream) => {
     // –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã–µ —Ç—Ä–µ–∫–∏ –∏ –ø–æ—Ç–æ–∫ –≤ `PeerConnection`
     stream.getTracks().forEach((t) => {
       this.pc.addTrack(t, stream)
     })

     // –¥–∞–Ω–Ω—ã–π –∑–∞—Ö–≤–∞—á–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ —è–≤–ª—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–º
     this.emit('localStream', stream)

     // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –∑–≤–æ–Ω–∫–∞,
     // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–≤–æ–Ω–æ–∫ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ,
     // –∏–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–± —É—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
     isCaller
       ? socket.emit('request', { to: this.remoteId })
       : this.createOffer()
   })
   // –∑–∞–ø—É—Å–∫–∞–µ–º –º–µ—Ç–æ–¥ `start` –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ `MediaDevices`
   .start(config)

 return this
}
```

–ú–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:

```javascript
stop(isCaller) {
 // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞,
 // —Å–æ–æ–±—â–∞–µ–º –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
 if (isCaller) {
   socket.emit('end', { to: this.remoteId })
 }
 // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞—Ö–≤–∞—Ç –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞
 this.mediaDevice.stop()
 // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–∏—Å—Ç–µ–º—É –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
 this.pc.restartIce()
 this.off()

 return this
}
```

–î–∞–ª–µ–µ —Å–ª–µ–¥—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–µ–¥–∏–∞—Å–µ—Å—Å–∏–∏:

```javascript
// –º–µ—Ç–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
createOffer() {
 this.pc.createOffer().then(this.getDescription).catch(console.error)

 return this
}

// –º–µ—Ç–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
createAnswer() {
 this.pc.createAnswer().then(this.getDescription).catch(console.error)

 return this
}

// –º–µ—Ç–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è –≤ `PeerConnection`
// –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω–µ
getDescription(desc) {
 this.pc.setLocalDescription(desc)

 socket.emit('call', { to: this.remoteId, sdp: desc })

 return this
}

// –º–µ—Ç–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ (–≤ –∑–Ω–∞—á–µ–Ω–∏–∏ "–Ω–∞—Ö–æ–¥—è—â–µ–≥–æ—Å—è –¥–∞–ª–µ–∫–æ") –æ–ø–∏—Å–∞–Ω–∏—è –≤ `PeerConnection`
setRemoteDescription(desc) {
 this.pc.setRemoteDescription(new RTCSessionDescription(desc))

 return this
}

// –º–µ—Ç–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ `PeerConnection`
addIceCandidate(candidate) {
 // –∫–∞–Ω–¥–∏–¥–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π
 if (candidate) {
   this.pc.addIceCandidate(new RTCIceCandidate(candidate))
 }

 return this
}
```

<spoiler title="–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:">

```javascript
import Emitter from './Emitter'
import MediaDevice from './MediaDevice'
import socket from './socket'

const CONFIG = { iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }] }

class PeerConnection extends Emitter {
 constructor(remoteId) {
   super()
   this.remoteId = remoteId

   this.pc = new RTCPeerConnection(CONFIG)
   this.pc.onicecandidate = ({ candidate }) => {
     socket.emit('call', {
       to: this.remoteId,
       candidate
     })
   }
   this.pc.ontrack = ({ streams }) => {
     this.emit('remoteStream', streams[0])
   }

   this.mediaDevice = new MediaDevice()

   this.getDescription = this.getDescription.bind(this)
 }

 start(isCaller, config) {
   this.mediaDevice
     .on('stream', (stream) => {
       stream.getTracks().forEach((t) => {
         this.pc.addTrack(t, stream)
       })

       this.emit('localStream', stream)

       isCaller
         ? socket.emit('request', { to: this.remoteId })
         : this.createOffer()
     })
     .start(config)

   return this
 }

 stop(isCaller) {
   if (isCaller) {
     socket.emit('end', { to: this.remoteId })
   }
   this.mediaDevice.stop()
   this.pc.restartIce()
   this.off()

   return this
 }

 createOffer() {
   this.pc.createOffer().then(this.getDescription).catch(console.error)

   return this
 }

 createAnswer() {
   this.pc.createAnswer().then(this.getDescription).catch(console.error)

   return this
 }

 getDescription(desc) {
   this.pc.setLocalDescription(desc)

   socket.emit('call', { to: this.remoteId, sdp: desc })

   return this
 }

 setRemoteDescription(desc) {
   this.pc.setRemoteDescription(new RTCSessionDescription(desc))

   return this
 }

 addIceCandidate(candidate) {
   if (candidate) {
     this.pc.addIceCandidate(new RTCIceCandidate(candidate))
   }

   return this
 }
}

export default PeerConnection
```

</spoiler>

–°–Ω–∞—á–∞–ª–∞ —è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã `MediaDevice` –∏ `PeerConnection` –≤ –≤–∏–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ö—É–∫–æ–≤, –Ω–æ –º–Ω–µ –Ω–µ –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –ø–æ—ç—Ç–æ–º—É —è –ø—Ä–µ–¥–ø–æ—á–µ–ª –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∫–ª–∞—Å—Å–∞–º.

–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º.

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

–ù–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω (`components/MainWindow.jsx`).

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ö—É–∫–∏, –∏–∫–æ–Ω–∫–∏ –∏ —Å–æ–∫–µ—Ç:

```javascript
import { useEffect, useState } from 'react'
import { BsCameraVideo, BsPhone } from 'react-icons/bs'

import socket from '../utils/socket'

// —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –º–µ—Ç–æ–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞
export const MainWindow = ({ startCall }) => {
 // TODO
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ (–Ω–∞—à–µ–≥–æ) –∏ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ (–≤ –∑–Ω–∞—á–µ–Ω–∏–∏ "–Ω–∞—Ö–æ–¥—è—â–∏–π—Å—è –¥–∞–ª–µ–∫–æ") `id`, –∞ —Ç–∞–∫–∂–µ –¥–ª—è –æ—à–∏–±–∫–∏:

```javascript
const [localId, setLocalId] = useState('')
const [remoteId, setRemoteId] = useState('')
const [error, setError] = useState('')
```

–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ `init`:

```javascript
useEffect(() => {
 socket
   .on('init', ({ id }) => {
     // –Ω–∞—à `id`, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
     setLocalId(id)
   })
   .emit('init')
}, [])
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:

```javascript
// –∑–≤–æ–Ω–æ–∫ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∫–∞–∫ —Å –≤–∏–¥–µ–æ, —Ç–∞–∫ –∏ –±–µ–∑ –Ω–µ–≥–æ
const callWithVideo = (video) => {
 // `id` –Ω–∞—à–µ–≥–æ –¥—Ä—É–≥–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑–∞–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º –ø–æ–ª–µ
 if (!remoteId.trim()) {
   return setError('Your friend ID must be specified!')
 }
 // –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞
 const config = { audio: true, video }
 // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `PeerConnection`
 startCall(true, remoteId, config)
}
```

–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É:

```javascript
return (
 <div className='container main-window'>
   <div className='local-id'>
     <h2>Your ID is</h2>
     <p>{localId}</p>
   </div>
   <div className='remote-id'>
     <label htmlFor='remoteId'>Your friend ID</label>
     <p className='error'>{error}</p>
     <input
       type='text'
       spellCheck={false}
       placeholder='Enter friend ID'
       onChange={({ target: { value } }) => {
         setError('')
         setRemoteId(value)
       }}
     />
     <div className='control'>
       {/* –≤–∏–¥–µ–æ –∑–≤–æ–Ω–æ–∫ */}
       <button onClick={() => callWithVideo(true)}>
         <BsCameraVideo />
       </button>
       {/* –∞—É–¥–∏–æ –∑–≤–æ–Ω–æ–∫ */}
       <button onClick={() => callWithVideo(false)}>
         <BsPhone />
       </button>
     </div>
   </div>
 </div>
)
```

<spoiler title="–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:">

```javascript
import { useEffect, useState } from 'react'
import { BsCameraVideo, BsPhone } from 'react-icons/bs'

import socket from '../utils/socket'

export const MainWindow = ({ startCall }) => {
 const [localId, setLocalId] = useState('')
 const [remoteId, setRemoteId] = useState('')
 const [error, setError] = useState('')

 useEffect(() => {
   socket
     .on('init', ({ id }) => {
       setLocalId(id)
     })
     .emit('init')
 }, [])

 const callWithVideo = (video) => {
   if (!remoteId.trim()) {
     return setError('Your friend ID must be specified!')
   }
   const config = { audio: true, video }
   startCall(true, remoteId, config)
 }

 return (
   <div className='container main-window'>
     <div className='local-id'>
       <h2>Your ID is</h2>
       <p>{localId}</p>
     </div>
     <div className='remote-id'>
       <label htmlFor='remoteId'>Your friend ID</label>
       <p className='error'>{error}</p>
       <input
         type='text'
         spellCheck={false}
         placeholder='Enter friend ID'
         onChange={({ target: { value } }) => {
           setError('')
           setRemoteId(value)
         }}
       />
       <div className='control'>
         <button onClick={() => callWithVideo(true)}>
           <BsCameraVideo />
         </button>
         <button onClick={() => callWithVideo(false)}>
           <BsPhone />
         </button>
       </div>
     </div>
   </div>
 )
}
```

</spoiler>

---

–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ (`components/CallModal.jsx`).

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ö—É–∫–∏ –∏ –∏–∫–æ–Ω–∫—É:

```javascript
import { BsCameraVideo, BsPhone } from 'react-icons/bs'
import { FiPhoneOff } from 'react-icons/fi'

// —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `id` –∑–≤–æ–Ω—è—â–µ–≥–æ –∏ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞ –∏ –µ–≥–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
export const CallModal = ({ callFrom, startCall, rejectCall }) => {
 // TODO
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–≤–æ–Ω–∫–∞:

```javascript
// –∑–≤–æ–Ω–æ–∫ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è —Å –≤–∏–¥–µ–æ –∏ –±–µ–∑
const acceptWithVideo = (video) => {
 const config = { audio: true, video }
 // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `PeerConnection`
 startCall(false, callFrom, config)
}
```

–ò –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É:

```javascript
return (
 <div className='call-modal'>
   <div className='inner'>
     <p>{`${callFrom} is calling`}</p>
     <div className='control'>
       {/* –ø—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫ —Å –≤–∏–¥–µ–æ */}
       <button onClick={() => acceptWithVideo(true)}>
         <BsCameraVideo />
       </button>
       {/* –ø—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫ –±–µ–∑ –≤–∏–¥–µ–æ */}
       <button onClick={() => acceptWithVideo(false)}>
         <BsPhone />
       </button>
       {/* –æ—Ç–∫–ª–æ–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫ */}
       <button onClick={rejectCall} className='reject'>
         <FiPhoneOff />
       </button>
     </div>
   </div>
 </div>
)
```

---

–≠–∫—Ä–∞–Ω –¥–ª—è –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ (`components/CallWindow.jsx`).

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ö—É–∫–∏ –∏ –∏–∫–æ–Ω–∫–∏:

```javascript
import { useState, useEffect, useRef } from 'react'
import { BsCameraVideo, BsPhone } from 'react-icons/bs'
import { FiPhoneOff } from 'react-icons/fi'

/*
 —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:
 - —É–¥–∞–ª–µ–Ω–Ω—ã–π –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫
 - –ª–æ–∫–∞–ª—å–Ω—ã–π –º–µ–¥–∏–∞ –ø–æ—Ç–æ–∫
 - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞
 - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—Ç–æ–∫–æ–º
 - –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
*/
export const CallWindow = ({
 remoteSrc,
 localSrc,
 config,
 mediaDevice,
 finishCall
}) => {
 // TODO
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Å—ã–ª–æ–∫ –Ω–∞ `DOM-—ç–ª–µ–º–µ–Ω—Ç—ã`, –∞ —Ç–∞–∫–∂–µ –¥–ª—è —Ä–∞–∑–º–µ—Ä–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –≤–∏–¥–µ–æ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ:

```javascript
const remoteVideo = useRef()
const localVideo = useRef()
const localVideoSize = useRef()
// –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ `null`,
// –ø–æ—ç—Ç–æ–º—É –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–¥–µ—Å—å –æ–ø–µ—Ä–∞—Ç–æ—Ä –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ `?.`
const [video, setVideo] = useState(config?.video)
const [audio, setAudio] = useState(config?.audio)
```

–° —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –º–Ω–µ –ø–æ–∫–∞–∑–∞–ª–æ—Å—å –ª–æ–≥–∏—á–Ω—ã–º —Å–¥–µ–ª–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç —Å —É–¥–∞–ª–µ–Ω–Ω—ã–º –≤–∏–¥–µ–æ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ - 90vh) –∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –µ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É. –° —Ä–∞–∑–º–µ—Ä–æ–º —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –≤–∏–¥–µ–æ —è —Ç–æ–∂–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª—Å—è –∏ —Å–¥–µ–ª–∞–ª –µ–≥–æ —Ä–∞–≤–Ω—ã–º 25vw –≤ —à–∏—Ä–∏–Ω—É. –ù–æ —è –Ω–µ –º–æ–≥ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å—Å—è —Å –ø–æ–ª–æ–∂–µ–Ω–∏–µ–º —ç—Ç–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –ø–æ—ç—Ç–æ–º—É —Ä–µ—à–∏–ª —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –µ–≥–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏–ª–∏, —Å–∫–æ—Ä–µ–µ, –ø–µ—Ä–µ–Ω–æ—Å–∞ (–∫–ª–∏–∫ -> –ø–µ—Ä–µ–Ω–æ—Å -> –∫–ª–∏–∫). –ü—Ä–∏ —ç—Ç–æ–º, —è —Ö–æ—Ç–µ–ª —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –Ω–∞–∏–±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º.

–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è (–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä) –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —ç–ª–µ–º–µ–Ω—Ç–∞:

```javascript
const [dragging, setDragging] = useState(false)
const [coords, setCoords] = useState({
 x: 0,
 y: 0
})
```

–í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –≤–∏–¥–µ–æ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∏—Ö –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:

```javascript
useEffect(() => {
 const { width, height } = localVideo.current.getBoundingClientRect()
 localVideoSize.current = { width, height }
}, [])
```

–î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∑–∞ —Å—á–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è `CSS-–∫–ª–∞—Å—Å–æ–≤`:

```javascript
useEffect(() => {
 dragging
   ? localVideo.current.classList.add('dragging')
   : localVideo.current.classList.remove('dragging')
}, [dragging])
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –≤–∏–¥–µ–æ:

```javascript
const onMouseMove = (e) => {
 // –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
 if (dragging) {
   // —ç—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∏—Ç—å—Å—è —Ç–æ–≥–æ,
   // —á—Ç–æ —Ü–µ–Ω—Ç—Ä –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å –∑–∞ –∫—É—Ä—Å–æ—Ä–æ–º
   setCoords({
     x: e.clientX - localVideoSize.current.width / 2,
     y: e.clientY - localVideoSize.current.height / 2
   })
 }
}
```

–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –æ–±—ä–µ–∫—Ç–µ `window`:

```javascript
useEffect(() => {
 window.addEventListener('mousemove', onMouseMove)

 return () => {
   window.removeEventListener('mousemove', onMouseMove)
 }
})
```

–î–∞–ª–µ–µ, –Ω–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–¥–∞—Ç—å –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∏ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã:

```javascript
useEffect(() => {
 // —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
 if (remoteVideo.current && remoteSrc) {
   remoteVideo.current.srcObject = remoteSrc
 }
 // –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
 if (localVideo.current && localSrc) {
   localVideo.current.srcObject = localSrc
 }
}, [remoteSrc, localSrc])
```

–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç—Ä–µ–∫–∏ –≤ –∑–Ω–∞—á–µ–Ω–∏—è, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞:

```javascript
useEffect(() => {
 if (mediaDevice) {
   // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–µ–æ—Ç—Ä–µ–∫–∏
   mediaDevice.toggle('Video', video)
   // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞—É–¥–∏–æ—Ç—Ä–µ–∫–∏
   mediaDevice.toggle('Audio', audio)
 }
}, [mediaDevice])
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ —Ç—Ä–µ–∫–æ–≤:

```javascript
const toggleMediaDevice = (deviceType) => {
 // –≤–∏–¥–µ–æ
 if (deviceType === 'video') {
   setVideo(!video)
   mediaDevice.toggle('Video')
 }
 // –∞—É–¥–∏–æ
 if (deviceType === 'audio') {
   setAudio(!audio)
   mediaDevice.toggle('Audio')
 }
}
```

–ù–∞–∫–æ–Ω–µ—Ü, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É:

```javascript
return (
 <div className='call-window'>
   <div className='inner'>
     <div className='video'>
       {/* —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ */}
       <video className='remote' ref={remoteVideo} autoPlay />
       {/*
         —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
         –æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –∞—Ç—Ä–∏–±—É—Ç `muted`,
         –±–µ–∑ –Ω–µ–≥–æ –º—ã –±—É–¥–µ–º —Å–ª—ã—à–∞—Ç—å —Å–∞–º–∏ —Å–µ–±—è,
         —á—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—é –∑–∞—Ç—Ä—É–¥–Ω–∏—Ç–µ–ª—å–Ω–æ–π
       */}
       <video
         className='local'
         ref={localVideo}
         autoPlay
         muted
         {/* –ø–µ—Ä–µ–Ω–æ—Å —ç–ª–µ–º–µ–Ω—Ç–∞ */}
         onClick={() => setDragging(!dragging)}
         style={{
           top: `${coords.y}px`,
           left: `${coords.x}px`
         }}
       />
     </div>
     <div className='control'>
       {/* –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ */}
       <button
         className={video ? '' : 'reject'}
         onClick={() => toggleMediaDevice('video')}
       >
         <BsCameraVideo />
       </button>
       {/* –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ */}
       <button
         className={audio ? '' : 'reject'}
         onClick={() => toggleMediaDevice('audio')}
       >
         <BsPhone />
       </button>
       {/* –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞ */}
       <button className='reject' onClick={() => finishCall(true)}>
         <FiPhoneOff />
       </button>
     </div>
   </div>
 </div>
)
```

<spoiler title="–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:">

```javascript
import { useState, useEffect, useRef } from 'react'
import { BsCameraVideo, BsPhone } from 'react-icons/bs'
import { FiPhoneOff } from 'react-icons/fi'

export const CallWindow = ({
 remoteSrc,
 localSrc,
 config,
 mediaDevice,
 finishCall
}) => {
 const remoteVideo = useRef()
 const localVideo = useRef()
 const localVideoSize = useRef()
 const [video, setVideo] = useState(config?.video)
 const [audio, setAudio] = useState(config?.audio)

 const [dragging, setDragging] = useState(false)
 const [coords, setCoords] = useState({
   x: 0,
   y: 0
 })

 useEffect(() => {
   const { width, height } = localVideo.current.getBoundingClientRect()
   localVideoSize.current = { width, height }
 }, [])

 useEffect(() => {
   dragging
     ? localVideo.current.classList.add('dragging')
     : localVideo.current.classList.remove('dragging')
 }, [dragging])

 useEffect(() => {
   window.addEventListener('mousemove', onMouseMove)

   return () => {
     window.removeEventListener('mousemove', onMouseMove)
   }
 })

 useEffect(() => {
   if (remoteVideo.current && remoteSrc) {
     remoteVideo.current.srcObject = remoteSrc
   }
   if (localVideo.current && localSrc) {
     localVideo.current.srcObject = localSrc
   }
 }, [remoteSrc, localSrc])

 useEffect(() => {
   if (mediaDevice) {
     mediaDevice.toggle('Video', video)
     mediaDevice.toggle('Audio', audio)
   }
 }, [mediaDevice])

 const onMouseMove = (e) => {
   if (dragging) {
     setCoords({
       x: e.clientX - localVideoSize.current.width / 2,
       y: e.clientY - localVideoSize.current.height / 2
     })
   }
 }

 const toggleMediaDevice = (deviceType) => {
   if (deviceType === 'video') {
     setVideo(!video)
     mediaDevice.toggle('Video')
   }
   if (deviceType === 'audio') {
     setAudio(!audio)
     mediaDevice.toggle('Audio')
   }
 }

 return (
   <div className='call-window'>
     <div className='inner'>
       <div className='video'>
         <video className='remote' ref={remoteVideo} autoPlay />
         <video
           className='local'
           ref={localVideo}
           autoPlay
           muted
           onClick={() => setDragging(!dragging)}
           style={{
             top: `${coords.y}px`,
             left: `${coords.x}px`
           }}
         />
       </div>
       <div className='control'>
         <button
           className={video ? '' : 'reject'}
           onClick={() => toggleMediaDevice('video')}
         >
           <BsCameraVideo />
         </button>
         <button
           className={audio ? '' : 'reject'}
           onClick={() => toggleMediaDevice('audio')}
         >
           <BsPhone />
         </button>
         <button className='reject' onClick={() => finishCall(true)}>
           <FiPhoneOff />
         </button>
       </div>
     </div>
   </div>
 )
}
```

</spoiler>

---

–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (`App.jsx`).

–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç–∏–ª–∏, —Ö—É–∫–∏, –∏–∫–æ–Ω–∫—É, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `PeerConnection` –∏ —Å–æ–∫–µ—Ç:

```javascript
import './styles/app.scss'

import { useState, useEffect } from 'react'
import { BsPhoneVibrate } from 'react-icons/bs'

import PeerConnection from './utils/PeerConnection'
import socket from './utils/socket'

import { MainWindow, CallWindow, CallModal } from './components'

export default function App() {
 // TODO
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è:

- `id` –∑–≤–æ–Ω—è—â–µ–≥–æ;
- –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è;
- –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è;
- –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞;
- —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫–∞;
- —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `PeerConnetion`;
- –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –º–µ–¥–∏–∞.

```javascript
const [callFrom, setCallFrom] = useState('')
const [calling, setCalling] = useState(false)

const [showModal, setShowModal] = useState(false)

const [localSrc, setLocalSrc] = useState(null)
const [remoteSrc, setRemoteSrc] = useState(null)

const [pc, setPc] = useState(null)
const [config, setConfig] = useState(null)
```

–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:

```javascript
useEffect(() => {
 socket.on('request', ({ from }) => {
   // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º `id` –∑–≤–æ–Ω—è—â–µ–≥–æ
   setCallFrom(from)
   // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
   setShowModal(true)
 })
}, [])
```

–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:

```javascript
// —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
// —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ `PeerConnection` - —ç—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–º
useEffect(() => {
 if (!pc) return

 socket
   // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é
   // –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –æ—Ç–≤–µ—Ç –∏ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ ICE (–≤ —Ç–æ–º —á–∏—Å–ª–µ, –≤ –≤–∏–¥–µ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–∏ - –Ω—É–ª–µ–≤–æ–π –∫–∞–Ω–¥–∏–¥–∞—Ç)
   .on('call', (data) => {
     // –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –æ–ø–∏—Å–∞–Ω–∏–µ
     if (data.sdp) {
       pc.setRemoteDescription(data.sdp)

       // –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
       if (data.sdp.type === 'offer') {
         // –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
         pc.createAnswer()
       }
     } else {
       // –¥–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞
       pc.addIceCandidate(data.candidate)
     }
   })
   // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
   .on('end', () => finishCall(false))
}, [pc])
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–≤–æ–Ω–∫–∞:

```javascript
/*
 —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç 3 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞:
 - —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä–æ–º –∑–≤–æ–Ω–∫–∞
 - `id` –∞–¥—Ä–µ—Å–∞—Ç–∞
 - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–µ–¥–∏–∞
*/
const startCall = (isCaller, remoteId, config) => {
 // —Å–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ - –¥–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –º—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫
 setShowModal(false)
 // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
 setCalling(true)
 // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
 setConfig(config)

 // —Å–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä `PeerConnection`,
 // –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–º—É `id` –∞–¥—Ä–µ—Å–∞—Ç–∞
 const _pc = new PeerConnection(remoteId)
   // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
   .on('localStream', (stream) => {
     setLocalSrc(stream)
   })
   // –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
   .on('remoteStream', (stream) => {
     setRemoteSrc(stream)
     // —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
     setCalling(false)
   })
   // –∑–∞–ø—É—Å–∫–∞–µ–º `PeerConnection`
   .start(isCaller, config)

 // –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä `PeerConnection`
 // —ç—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
 // –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –∑–≤–æ–Ω–∫—É –∏ –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
 setPc(_pc)
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:

```javascript
const rejectCall = () => {
 socket.emit('end', { to: callFrom })

 setShowModal(false)
}
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞:

```javascript
const finishCall = (isCaller) => {
 // –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É `WebRTC`
 pc.stop(isCaller)

 // –æ–±–Ω—É–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
 setPc(null)
 setConfig(null)

 setCalling(false)
 setShowModal(false)

 setLocalSrc(null)
 setRemoteSrc(null)
}
```

–ò –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–∞–∑–º–µ—Ç–∫—É:

```javascript
return (
 <div className='app'>
   <h1>React WebRTC</h1>
   {/* –Ω–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω */}
   <MainWindow startCall={startCall} />
   {/* –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */}
   {calling && (
     <div className='calling'>
       <button disabled>
         <BsPhoneVibrate />
       </button>
     </div>
   )}
   {/* –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */}
   {showModal && (
     <CallModal
       callFrom={callFrom}
       startCall={startCall}
       rejectCall={rejectCall}
     />
   )}
   {/* —ç–∫—Ä–∞–Ω –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ */}
   {remoteSrc && (
     <CallWindow
       localSrc={localSrc}
       remoteSrc={remoteSrc}
       config={config}
       mediaDevice={pc?.mediaDevice}
       finishCall={finishCall}
     />
   )}
 </div>
)
```

<spoiler title="–ü–æ–ª–Ω—ã–π –∫–æ–¥ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:">

```javascript
import './styles/app.scss'

import { useState, useEffect } from 'react'
import { BsPhoneVibrate } from 'react-icons/bs'

import PeerConnection from './utils/PeerConnection'
import socket from './utils/socket'

import { MainWindow, CallWindow, CallModal } from './components'

export default function App() {
 const [callFrom, setCallFrom] = useState('')
 const [calling, setCalling] = useState(false)

 const [showModal, setShowModal] = useState(false)

 const [localSrc, setLocalSrc] = useState(null)
 const [remoteSrc, setRemoteSrc] = useState(null)

 const [pc, setPc] = useState(null)
 const [config, setConfig] = useState(null)

 useEffect(() => {
   socket.on('request', ({ from }) => {
     setCallFrom(from)
     setShowModal(true)
   })
 }, [])

 useEffect(() => {
   if (!pc) return

   socket
     .on('call', (data) => {
       if (data.sdp) {
         pc.setRemoteDescription(data.sdp)

         if (data.sdp.type === 'offer') {
           pc.createAnswer()
         }
       } else {
         pc.addIceCandidate(data.candidate)
       }
     })
     .on('end', () => finishCall(false))
 }, [pc])

 const startCall = (isCaller, remoteId, config) => {
   setShowModal(false)
   setCalling(true)
   setConfig(config)

   const _pc = new PeerConnection(remoteId)
     .on('localStream', (stream) => {
       setLocalSrc(stream)
     })
     .on('remoteStream', (stream) => {
       setRemoteSrc(stream)
       setCalling(false)
     })
     .start(isCaller, config)

   setPc(_pc)
 }

 const rejectCall = () => {
   socket.emit('end', { to: callFrom })

   setShowModal(false)
 }

 const finishCall = (isCaller) => {
   pc.stop(isCaller)

   setPc(null)
   setConfig(null)

   setCalling(false)
   setShowModal(false)

   setLocalSrc(null)
   setRemoteSrc(null)
 }

 return (
   <div className='app'>
     <h1>React WebRTC</h1>
     <MainWindow startCall={startCall} />
     {calling && (
       <div className='calling'>
         <button disabled>
           <BsPhoneVibrate />
         </button>
       </div>
     )}
     {showModal && (
       <CallModal
         callFrom={callFrom}
         startCall={startCall}
         rejectCall={rejectCall}
       />
     )}
     {remoteSrc && (
       <CallWindow
         localSrc={localSrc}
         remoteSrc={remoteSrc}
         config={config}
         mediaDevice={pc?.mediaDevice}
         finishCall={finishCall}
       />
     )}
   </div>
 )
}
```

</spoiler>

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

–ü–æ–¥–Ω–∏–º–∞–µ–º—Å—è –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (`react-webrtc`), –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º `Node.js-–ø—Ä–æ–µ–∫—Ç` –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º [`concurrently`](https://www.npmjs.com/package/concurrently) - —É—Ç–∏–ª–∏—Ç—É –¥–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–∞–Ω–¥, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –≤ `package.json`:

```bash
cd ..

yarn init -yp

yarn add concurrently
```

–û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ `package.json` –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:

```json
"scripts": {
 "dev": "concurrently \"yarn --cwd server dev\" \"yarn --cwd client dev\""
}
```

–û—Ç–∫—Ä—ã–≤–∞–µ–º —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –≤—ã–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—É—é –∫–æ–º–∞–Ω–¥—É —Å –ø–æ–º–æ—â—å—é `yarn dev`.

–ü–æ–ª—É—á–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:4000` –∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –∞–¥—Ä–µ—Å—É `http://localhost:3000`.

–û—Ç–∫—Ä—ã–≤–∞–µ–º 2 –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ —Å –∫–ª–∏–µ–Ω—Ç–æ–º:

<img src="https://habrastorage.org/webt/og/ce/_v/ogce_v2r7ekvtfh64t8s-f1x7ga.png" />
<br />

–ö–æ–ø–∏—Ä—É–µ–º `id` —Å –æ–¥–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏, –≤—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –ø–æ–ª–µ `Your friend ID` –≤ –¥—Ä—É–≥–æ–π –≤–∫–ª–∞–¥–∫–µ –∏ –Ω–∞–∂–∏–º–∞–µ–º –Ω–∞ –∏–∫–æ–Ω–∫—É –≤–∏–¥–µ–æ–∫–∞–º–µ—Ä—ã.

–ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–∞—à–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ–∫–∞–º–µ—Ä—ã –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –µ–º—É —Ç–∞–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ. –í —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è, –∞ –≤ –¥—Ä—É–≥–æ–π - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ:

<img src="https://habrastorage.org/webt/ph/r0/z_/phr0z_twkfjpq6lgu_1t-ukj7xa.png" />
<br />

–ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–≤–æ–Ω–æ–∫ —Å –≤–∏–¥–µ–æ. –ü–æ—è–≤–ª—è–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏:

<img src="https://habrastorage.org/webt/nh/zc/ta/nhzctavsre0xvefj5by9r8tq3d8.png" />
<br />

–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ, –º–µ–Ω—è–µ–º –ø–æ–ª–æ–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –≤–∏–¥–µ–æ:

<img src="https://habrastorage.org/webt/-5/j5/xo/-5j5xoj9vknruqqye__ggcr51dm.png" />
<br />

–ò –∑–∞–≤–µ—Ä—à–∞–µ–º –∑–≤–æ–Ω–æ–∫.

–ö—Ä—É—Ç–æ! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è.

–ü–æ–∂–∞–ª—É–π, —ç—Ç–æ –≤—Å–µ, —á–µ–º —è —Ö–æ—Ç–µ–ª –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å –≤–∞–º–∏ –≤ –¥–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–µ.

–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–Ω–∏–º–∞–Ω–∏–µ –∏ happy coding!